---
title: "Gastrulation scNMT-seq: dimensionality reduction on RNA data"
output: 
  BiocStyle::html_document: 
  fig_width: 10
  fig_height: 8
---
  
```{r load_modules, echo=FALSE, include=FALSE}
library(scater)
library(RColorBrewer)
library(umap)
```

<!-- Define I/O -->
```{r define_io, echo=FALSE}
source("/Users/ricard/scnmt_gastrulation/settings.R")
io$outdir <- paste0(io$basedir,"/rna/dimensionality_reduction")
```

<!-- Define options -->
```{r}
# Define which cells to use
opts$stage_lineage <- c(
  # "E4.5_Epiblast",
  # "E5.5_Epiblast",
  # "E6.5_Epiblast",
  # "E6.5_Primitive_Streak",
  # "E6.5_Mesoderm",
  "E7.5_Epiblast",
  # "E7.5_Primitive_Streak",
  "E7.5_Ectoderm"
  # "E7.5_Endoderm",
  # "E7.5_Mesoderm"
)

# Stage-specific colors for RNA
opts$stage.colors <- c(
  E4.5="#B2E2E2", 
  E5.5="#66C2A4", 
  E6.5="#2CA25F", 
  E7.5="#006D2C"
)
```


Update sample metadata

```{r}
foo <- fread("/Users/ricard/data/gastrulation/rna/results/mapping/mapping.txt.gz") %>%
  .[,c("id_rna","celltype.mapped","celltype.score")]
sample_metadata <- sample_metadata %>% 
  merge(foo,by="id_rna") %>%
  .[,stage_lineage:=paste(stage,celltype.mapped,sep="_")]
```

```{r}
opts$stage_lineage <- c(
  "E7.5_Rostral_neurectoderm",
  # "E6.5_Epiblast",
  "E7.5_Epiblast"
)

sample_metadata <- sample_metadata %>% 
  .[pass_rnaQC==T & stage_lineage%in%opts$stage_lineage] %>%
  .[,c("id_rna","stage","lineage10x","celltype.mapped","stage_lineage")]
table(sample_metadata$lineage10x)
table(sample_metadata$celltype.mapped)
```

```{r}
# sample_metadata <- sample_metadata %>% 
#   .[pass_rnaQC==T & stage_lineage%in%opts$stage_lineage] %>%
#   .[,c("id_rna","stage","lineage10x","lineage10x_2","stage_lineage")]
```

Load RNA expression data
```{r load_data, echo=FALSE}
sce <- readRDS(io$rna)[,sample_metadata$id_rna]
```

Parse RNA expression data
```{r}
sce$stage_lineage <- sample_metadata$stage_lineage
sce$lineage <- sample_metadata$lineage10x_2

sce$celltype.1 <- sample_metadata$lineage10x
sce$celltype.2 <- sample_metadata$celltype.mapped
```

Select HVG
```{r}
decomp <- modelGeneVar(sce)
decomp <- decomp[decomp$mean > 0.01,]
hvgs <- rownames(decomp)[decomp$p.value <= 0.01]

# Subset SingleCellExperiment
sce_filt <- sce[hvgs,]
```

Regress out covariates
```{r}
data <- scale(t(logcounts(sce_filt)), center = T, scale = F)
# data_regressed <- apply(data, 2, function(x) {
#   lm.out <- lm(formula=expr~covariate, data=data.frame(expr=x, covariate=factor(sce_filt$stage)));
#   residuals <- lm.out[["residuals"]]+lm.out[["coefficients"]][1]
# })
```

Run PCA
```{r}
npcs <- 15
reducedDim(sce_filt, "PCA") <- irlba::prcomp_irlba(data, n=npcs)$x[,2:npcs]
```

```{r}
cor(colMeans(counts(sce_filt)>0), reducedDim(sce_filt,"PCA"))
```


Plot PCA
```{r}
plotPCA(sce_filt, colour_by="celltype.1", ncomponents = c(3,4))# +
plotPCA(sce_filt, colour_by="celltype.2", ncomponents = c(3,4))# +
  # scale_fill_manual(values=opts$celltype.colors)
```

Run UMAP
```{r}
set.seed(42)
sce_filt <- runUMAP(sce_filt, dimred="PCA", n_neighbors = 35, min_dist = 0.45)
reducedDim(sce, "UMAP") <- reducedDim(sce_filt, "UMAP") 
```

Plot UMAP
```{r}
to.plot <- reducedDim(sce_filt,"UMAP") %>% as.data.table %>% 
  .[,id_rna:=colnames(sce_filt)] %>%
    merge(sample_metadata, by="id_rna")

p <- ggplot(to.plot, aes(x=V1, y=V2, fill=stage_lineage)) +
  geom_point(size=2, shape=21) +
  # scale_color_manual(values=opts$stage.colors) +
  # scale_fill_manual(values=opts$celltype.colors) +
  theme_classic() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position="right",
    legend.title=element_blank()
  )

# pdf(paste0(io$outdir,"/rna_umap.pdf"), width=5, height=3, useDingbats = F)
print(p)
# dev.off()
```
