---
title: "Gastrulation scNMT-seq: dimensionality reduction on RNA data"
---
  
```{r load_modules, message=FALSE}
library(SingleCellExperiment)
library(scran)
library(scater)
```

# Define settings 

Define I/O
```{r define_io}
source("/Users/ricard/scnmt_gastrulation/settings.R")
io$outdir <- paste0(io$basedir,"/rna/results/dimensionality_reduction")
```

Define options
```{r}
# Define which cells to use
opts$stage_lineage <- c(
  "E4.5_Epiblast",
  "E4.5_Primitive_endoderm",
  "E5.5_Epiblast",
  "E5.5_Visceral_endoderm",
  "E6.5_Epiblast",
  "E6.5_Primitive_Streak",
  "E6.5_Visceral_endoderm",
  "E6.5_Mesoderm",
  "E7.5_Epiblast",
  "E7.5_Primitive_Streak",
  "E7.5_Ectoderm",
  "E7.5_Endoderm",
  "E7.5_Mesoderm"
)

# Stage-specific colors for RNA
opts$stage.colors <- c(
  E4.5="#B2E2E2",
  E5.5="#66C2A4",
  E6.5="#2CA25F",
  E7.5="#006D2C"
)
```

Update sample metadata
```{r}
sample_metadata <- sample_metadata %>% 
  .[pass_rnaQC==T & stage_lineage%in%opts$stage_lineage] %>%
  .[,c("id_rna","stage","lineage10x_2","stage_lineage")]
table(sample_metadata$stage_lineage)
```

# Load RNA expression data

```{r load_data}
stop()
# sce <- readRDS(io$rna)[,sample_metadata$id_rna]
# sce
```

Parse RNA expression data
```{r}
sce$stage_lineage <- sample_metadata$stage_lineage
sce$lineage <- sample_metadata$lineage10x_2

# sce$celltype.1 <- sample_metadata$lineage10x
# sce$celltype.2 <- sample_metadata$celltype.mapped
```

Select HVG
```{r}
decomp <- modelGeneVar(sce)
hvgs <- rownames(decomp)[decomp$p.value<0.01 & decomp$mean > 0.01]
```

Plot HVG
```{r}
to.plot <- data.table(
  mean = apply(logcounts(sce),1,mean),
  var = apply(logcounts(sce),1,var),
  hvg = decomp$p.value < 0.01
) %>% .[is.na(hvg),hvg:=F]

ggplot(to.plot, aes(x=mean, y=var)) +
  geom_point(aes(fill=hvg, size=hvg), shape=21, stroke=0.1) +
  stat_smooth() +
  scale_fill_manual(values=c("black","red")) +
  scale_size_manual(values=c(0.8,1.6)) +
  guides(fill = guide_legend(override.aes = list(size=2.5))) +
  xlab('Mean') + ylab('Variance') +
  theme_classic()
```

Subset SingleCellExperiment
```{r}
sce_filt <- sce[hvgs,]
sce_filt
```

(Optional) Regress out covariates
```{r}
data <- scale(t(logcounts(sce_filt)), center = T, scale = F)
# data_regressed <- apply(data, 2, function(x) {
#   lm.out <- lm(formula=expr~covariate, data=data.frame(expr=x, covariate=factor(sce_filt$stage)));
#   residuals <- lm.out[["residuals"]]+lm.out[["coefficients"]][1]
# })
```

# Dimensionality reduction

Run PCA
```{r}
npcs <- 15
reducedDim(sce_filt, "PCA") <- irlba::prcomp_irlba(data, n=npcs)$x[,1:npcs]
```

```{r}
# cor(colMeans(counts(sce_filt)>0), reducedDim(sce_filt,"PCA"))
```


Plot PCA
```{r echo=FALSE}
# plotPCA(sce_filt, colour_by="stage", ncomponents = c(1,2))# +
# scale_fill_manual(values=opts$celltype.colors)
```

Run UMAP
```{r}
set.seed(41)
sce_filt <- runUMAP(sce_filt, dimred="PCA", n_neighbors = 15, min_dist = 0.55)
reducedDim(sce, "UMAP") <- reducedDim(sce_filt, "UMAP") 
```

Plot UMAP

```{r}
to.plot <- reducedDim(sce_filt,"UMAP") %>% as.data.table %>% 
  .[,id_rna:=colnames(sce_filt)] %>%
    merge(sample_metadata, by="id_rna")
```

```{r}
# to.plot2 <- to.plot[500:1000]

p <- ggplot(to.plot, aes(x=V1, y=V2, fill=lineage10x_2)) +
  geom_point(size=4, shape=21) +
  # scale_color_manual(values=opts$stage.colors) +
  scale_fill_manual(values=opts$celltype2.colors) +
  theme_classic() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    legend.position="none",
    legend.title=element_blank()
  )

pdf(paste0(io$outdir,"/rna_umap_v2.pdf"), width=6, height=5, useDingbats = F)
print(p)
dev.off()
```

```{r}
colors <- c(
  "E4.5_Epiblast" = "steelblue 1",
  "E4.5_Primitive_endoderm" = "#7CCD7C",
  "E5.5_Epiblast" = "steelblue 1",
  "E5.5_Visceral_endoderm" = "#7CCD7C",
  "E6.5_Epiblast" = "steelblue 1",
  "E6.5_Primitive_Streak" = "sandybrown",
  "E6.5_Visceral_endoderm" = "#7CCD7C",
  "E6.5_Mesoderm" = "#CD3278",
  "E7.5_Epiblast" = "steelblue 1",
  "E7.5_Primitive_Streak" = "sandybrown",
  "E7.5_Ectoderm" = "steelblue 1",
  "E7.5_Endoderm" = "#43CD80",
  "E7.5_Mesoderm" = "#CD3278"
)
alpha <- rep(1.0, length(colors))
names(alpha) <- names(colors)
 
for (i in names(opts$stage.colors)) {
  
  alpha_i <- alpha
  alpha_i[grep(i,opts$stage_lineage, invert = T)] <- 0.25
  
  colors_i <- colors
  colors_i[grep(i,opts$stage_lineage, invert = T)] <- "grey"
  
  p <- ggplot(to.plot, aes(x=V1, y=V2, fill=stage_lineage, alpha=stage_lineage)) +
    geom_point(size=2, shape=21) +
    # scale_size_manual(values = c("TRUE"=0.55, "FALSE"=0.15)) +
    scale_fill_manual(values=colors_i) +
    scale_alpha_manual(values=alpha_i) +
    # scale_fill_manual(values=opts$celltype2.colors) +
    theme_classic() +
    theme(
      axis.title = element_blank(),
      axis.text = element_blank(),
      axis.ticks = element_blank(),
      axis.line = element_blank(),
      legend.position="none"
    )
  
  pdf(sprintf("%s/rna_umap_%s.pdf",io$outdir,i), width=3, height=3, useDingbats = F)
  print(p)
  dev.off()
}
```


index <- match(plot_df$cell, as.character(mapping$closest.cell) )
plot_df$mapped <- as.factor(!is.na(index))
  
p <- ggplot(data=plot_df, mapping=aes(x=V1, y=V2, colour=mapped)) +
  ggrastr::geom_point_rast(aes(size=mapped), alpha=opts$dot_alpha) +
  # geom_point(aes(size=mapped), alpha=opts$dot_alpha) +

```{r}

```
